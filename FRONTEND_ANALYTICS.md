# Инструкция для фронтенда - Analytics API

## Краткое описание

API для получения данных аналитики для графиков. Данные автоматически обновляются каждые 10 минут.

## Основные эндпоинты

### 1. Получение данных графика
**GET** `/analytics/chart`

**Query параметры:**
- `clientTIN` (опционально) - ИНН клиента или несколько через запятую: `"7702785539,1234567890"`

**Ответ:**
```json
{
  "data": [
    {
      "date": "2024-05-05",
      "quantityByRequest": 0,    // По заявке
      "quantityByPlan": 0,       // По плану
      "quantityByFact": 1,       // По факту
      "quantityByDeparture": 0   // Убытие
    }
  ],
  "defaultClientTIN": "7702785539",  // Первый доступный клиент
  "availableClients": [              // Список доступных клиентов
    {
      "TIN": "7702785539",
      "companyName": "ООО \"ДЕНТСПЛАЙ СИРОНА\""
    }
  ],
  "lastImportAt": "2024-01-15T10:30:00.000Z"  // Дата последнего обновления
}
```

### 2. Информация о последнем обновлении
**GET** `/analytics/meta/last-import`

**Ответ:**
```json
{
  "lastImportAt": "2024-01-15T10:30:00.000Z",
  "recordsImported": 1000,
  "recordsUpdated": 500,
  "recordsDeleted": 50,
  "recordsSkipped": 10,
  "errors": 0
}
```

## Особенности реализации

### По умолчанию
- Если `clientTIN` не указан, используется **первый доступный клиент** пользователя (поле `defaultClientTIN`)

### Множественный выбор клиентов
- При указании нескольких ИНН через запятую (`clientTIN=7702785539,1234567890`), данные **автоматически суммируются** по датам

### Зум графика
- Зум графика обрабатывается на клиенте (ApexCharts), без дополнительных запросов к серверу
- Все данные загружаются один раз, график сам управляет отображением видимого диапазона

### Структура данных для ApexCharts

**Ось X**: даты из поля `date` (формат `"YYYY-MM-DD"`)

**Ось Y**: 4 серии данных:
1. `quantityByRequest` - По заявке
2. `quantityByPlan` - По плану
3. `quantityByFact` - По факту
4. `quantityByDeparture` - Убытие

## Пример использования

```typescript
// 1. Загрузка начальных данных (без фильтров - используется первый клиент)
const initialData = await fetch('/analytics/chart', {
  headers: { 'Authorization': `Bearer ${token}` }
})

// 2. Отображение списка доступных клиентов
const availableClients = initialData.availableClients

// 3. При выборе клиентов - загрузка с фильтром
const data = await fetch(`/analytics/chart?clientTIN=7702785539,1234567890`, {
  headers: { 'Authorization': `Bearer ${token}` }
})
```

## Важно

- ✅ Автоматическое обновление данных каждые 10 минут
- ✅ По умолчанию показывается первый доступный клиент
- ✅ При выборе нескольких клиентов данные суммируются
- ✅ Зум графика обрабатывается на клиенте (без запросов к серверу)
- ✅ Дата последнего обновления доступна в поле `lastImportAt`

